// 世紀輪廻メモリア 開発用分岐テンプレート

// --- ゲーム状態管理 ---
const GameState = {
  chapter: 1,                // 現在の章
  affection: {               // 好感度
    Miku: 0,
    Shizuka: 0,
    Rena: 0
  },
  flags: {                   // フラグ管理
    F_Miku_Help: false,
    F_Library_Key: false,
    F_Council_Pass: false,
    F_Rooftop_Promise: false,
    F_Forbidden_Tome: false,
    F_Shrine_Access: false
  },
  BellShard: 0,              // 鐘の断片数
  hiddenUnlocked: false      // 隠しルート解放
};

// --- 選択肢定義 ---
const Choices = {
  commonChapter1: [
    { label: "未来の部誌手伝い", affect: {Miku: 2}, flag: "F_Miku_Help" },
    { label: "図書室で静の整理手伝い", affect: {Shizuka: 2}, flag: "F_Library_Key" },
    { label: "生徒会の資料運び", affect: {Rena: 2}, flag: "F_Council_Pass" }
  ],
  commonChapter2: [
    { label: "未来と前夜祭", affect: {Miku: 2} },
    { label: "静と前夜祭", affect: {Shizuka: 2} },
    { label: "玲奈と前夜祭", affect: {Rena: 2} }
  ]
  // 各章・ルートの選択肢は同様に追加可能
};

// --- チャプター進行関数 ---
function nextChapter() {
  GameState.chapter += 1;
  switch(GameState.chapter) {
    case 2:
      startChapter2();
      break;
    case 3:
      startChapter3();
      break;
    default:
      checkHiddenRoute();
      break;
  }
}

// --- 共通ルート第2章 ---
function startChapter2() {
  // ここで選択肢を表示
  // 例: showChoices(Choices.commonChapter2);
}

// --- 共通ルート第3章（零時の囁き） ---
function startChapter3() {
  // 最大好感度ヒロインの判定
  const maxAffection = Math.max(...Object.values(GameState.affection));
  const candidates = Object.keys(GameState.affection).filter(
    key => GameState.affection[key] === maxAffection
  );
  
  // 同率の場合は選択肢を表示、単独なら自動ルート移行
  if(candidates.length > 1) {
    // showChoiceForTie(candidates);
  } else {
    // moveToRoute(candidates[0]);
  }
}

// --- 個別ルート関数（例：未来ルート） ---
function mikuRoute() {
  // 章1：雨宿りの屋上
  // setFlag('F_Rooftop_Promise');

  // 章2：写真部暗室
  // 選択：真実を掘る / 今を守る

  // 章3：星祭の告白
  // Good / Bitter / Bad の分岐
}

// --- 静ルート ---
function shizukaRoute() {
  // 章1：禁書「世紀紋章」
  // 章2：地下資料庫
  // 章3：現し世と記憶の境
}

// --- 玲奈ルート ---
function renaRoute() {
  // 章1：儀礼の段取り
  // 章2：代償
  // 章3：0:00の選択
}

// --- 隠しルート判定 ---
function checkHiddenRoute() {
  const goodOrBitterAll =
    GameState.affection.Miku > 0 &&
    GameState.affection.Shizuka > 0 &&
    GameState.affection.Rena > 0 &&
    GameState.BellShard >= 5;

  const noBad = true; // 周回でBad踏まない場合
  if(goodOrBitterAll && noBad) {
    GameState.hiddenUnlocked = true;
    startHiddenChapter();
  }
}

// --- 隠し章 ---
function startHiddenChapter() {
  // 夢の人物登場
  // 選択肢：
  // 1. 日常を守り輪廻を受け入れる
  // 2. 3人の選択総和で輪廻を停止
}

// --- フラグ設定関数 ---
function setFlag(flagName) {
  GameState.flags[flagName] = true;
}

// --- 好感度増加関数 ---
function increaseAffection(character, value) {
  if(GameState.affection[character] !== undefined) {
    GameState.affection[character] += value;
  }
}

// --- BellShard増加関数 ---
function gainBellShard(amount) {
  GameState.BellShard += amount;
}
